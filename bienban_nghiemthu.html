<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>Biên bản nghiệm thu</title>
    <meta name="csrf-token" content="MHMXdIG4tBlzbq7sMs8y0wjq43Dtbf8PaMgnKDS3">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="shortcut icon" href="https://rndwows.github.io/hcnswows/logowows.jpg" type="image/x-icon">
    <!-- jQuery library -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        body {
            background: rgb(204, 204, 204);
            font-family: "Times New Roman", Times, serif;
        }

        .fixed-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100%;
            max-width: 200px;
        }

        page {
            background: white;
            display: block;
            margin: 0 auto;
            margin-bottom: 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
        }

        page[size="A4"][layout="landscape"] {
            width: 29.7cm;
            height: 100%;
        }

        .table {
            table-layout: fixed;
            width: 100%;
        }

        .col-stt {
            width: 5%;
        }

        .col-ten-sp {
            width: 10%;
        }

        .col-quy-cach {
            width: 40%;
        }

        .col-dvt {
            width: 6%;
        }

        .col-so-luong {
            width: 5%;
        }

        .col-link {
            width: 10%;
        }

        .col-thoi-gian {
            width: 16%;
        }

        .col-nghiem-thu {
            width: 8%;
        }

        .table th,
        .table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }

        @media print {

            /* Thêm dòng này vào phần @media print hiện tại */
            #content {
                zoom: 0.85 !important;
                /* Thu nhỏ toàn bộ nội dung */
            }
        }

        @media print {

            .table th,
            .table td {
                overflow: visible;
                white-space: normal;
                word-wrap: break-word;
            }

            .link-bangiao,
            .nguoi-tiepnhan {
                display: none;
            }

            .print-only {
                display: inline;
            }

            body,
            #content {
                margin: 0;
                box-shadow: 0;
                font-size: 18px !important;
            }

            h5 {
                font-size: 24px
            }

            .date-input {
                display: none;
            }

            .no-print {
                display: none !important;
            }

            .big-title {
                font-size: 18px !important;
            }

            .total-pay {
                font-size: 15px !important;
            }

            @page {
                size: auto;
            }

            #content-split {
                margin-top: 40px;
                position: absolute;
                top: 50%;
                width: 920px;
            }

            .height_hr {
                border-top: 3px dashed black;
                width: 100%;
                position: absolute;
                top: 49%;
            }

            #content-split .div-logo {
                position: relative;
                top: -10px;
                left: 10px;
            }

            #sequenceNumber {
                display: none;
            }

            .participant-row.empty {
                display: none !important;
            }

            .participant-table input[type="text"] {
                border: none;
                border-bottom: none !important;
                text-align: left;
                padding-left: 0;
                background: transparent;
                -webkit-box-shadow: none;
                box-shadow: none;
            }

            .participant-table td {
                text-align: left;
            }

            .company-header {
                text-align: left;
                font-weight: bold;
            }

            .print-align-left {
                text-align: left !important;
            }

            .participant-table input[type="text"]:focus {
                outline: none;
                border: none;
                -webkit-box-shadow: none;
                box-shadow: none;
            }

            .signature-input {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }
        }

        #content {
            font-size: 13.5px;
            padding: 40px 40px;
        }

        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        .bold {
            font-weight: bold;
        }

        .big-title {
            font-size: 15px;
            text-transform: uppercase;
            font-weight: bold;
            padding-bottom: 5px;
        }

        #fixed-panel,
        #fixed-show-user,
        #fixed-show-reason {
            font-size: 13px;
        }

        #select-setup-print {
            position: relative;
            top: -2px;
            background-color: #17a2b8;
            color: white;
        }

        #setup-print {
            position: fixed;
            top: 480px;
            left: 30px;
            width: 150px;
            height: 54px;
            background-color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 0.5cm rgba(0, 0, 0, 0.5);
        }

        .heigth-90px {
            height: 90px !important;
        }

        #page {
            margin-top: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .center-content {
            text-align: center;
            vertical-align: middle;
        }

        hr {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .table-center th {
            text-align: center;
            vertical-align: middle;
        }

        .info_student {
            margin-top: 10px;
            text-align: justify;
        }

        .info_contract {
            margin-bottom: 5px !important
        }

        .preserve-format {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .table thead th {
            vertical-align: middle;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .table-bordered {
            border: 1px solid #dee2e6;
        }

        .form-control.link-bangiao,
        .form-control.nguoi-tiepnhan {
            width: 100%;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.3;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.2rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .table td {
            padding: 0.4rem;
        }

        @media screen {
            .print-only {
                display: none;
            }

            .signature-input {
                display: block;
            }
        }

        .signature-input {
            font-weight: bold;
            padding: 5px;
            margin: 0;
            width: 100%;
        }

        .signature-input:focus {
            outline: none;
            border-bottom: 2px solid #555;
        }

        @media only screen and (max-width: 1024px) {
            #fixed-panel {
                display: none !important;
            }

            #list_option_print {
                display: none !important;
            }
        }

        @media screen and (max-width: 600px) {
            .table-responsive {
                overflow-x: auto;
            }
        }

        .participants-container {
            display: flex;
        }

        .participant-table {
            width: 100%;
            border-collapse: collapse;
        }

        .participant-table th,
        .participant-table td {
            padding: 5px;
            border: none;
        }

        .company-header {
            font-weight: bold;
            text-align: left;
        }

        .participant-table input[type="text"] {
            border: none;
            border-bottom: 1px solid #ccc;
            outline: none;
            padding: 2px;
            width: 70%;
        }

        .participant-table input[type="text"]:focus {
            border-bottom: 2px solid #555;
        }

        .participant-row {
            transition: opacity 0.3s ease;
        }

        .participant-row[style*="display: none"] {
            opacity: 0;
        }

        /* Checkbox styling */
        .checkbox-container {
            display: block;
            position: relative;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .checkbox-container:hover input~.checkmark {
            background-color: #ccc;
        }

        .checkbox-container input:checked~.checkmark {
            background-color: #2196F3;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked~.checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
    </style>
</head>

<body>
    <button onclick="print()" class="btn btn-info fixed-button" style="width: 100%"><i class="fa fa-print"></i> <span
            class="language_print">In</span></button>
    <page size="A4" id="page" layout="landscape">
        <div id="content">
            <div class="content_page1">
                <table style="width: 100%;">
                    <tr>
                        <td rowspan="4"> <img src="https://rndwows.github.io/hcnswows/logowows.jpg"
                                style="width: 100px; margin: -30px"></td>
                        <td style="width: 60%;" rowspan="4" class="center">
                            <h4 class="bold">CÔNG TY CỔ PHẦN TẬP ĐOÀN WOWS</h4>
                        </td>
                        <td style="font-size: 12px;">Mã hiệu: </td>
                        <td style="font-size: 12px;"><span>WS-KD-QT02/BM05</span></td>
                    </tr>
                    <tr>
                        <td style="font-size: 12px;"> Lần ban hành: 01</td>
                        <td style="font-size: 12px;">Hiệu chỉnh lần: 00</td>
                    </tr>
                    <tr>
                        <td style="font-size: 12px;">Ngày ban hành: <span>01/07/2024</span></td>
                        <td style="font-size: 12px;">Ngày hiệu chỉnh: <span>00</span></td>
                    </tr>
                    <tr>
                        <td style="font-size: 12px;">Số:</td>
                        <td style="font-size: 12px;">BNT-<span id="Tvt"></span>-<span id="currentDate"></span>-<input
                                type="text" id="sequenceNumber" class="no-print"
                                style="width: 40px; border: none; border-bottom: 1px solid black;"><span
                                id="sequenceNumberDisplay"></span>
                        </td>
                    </tr>
                </table>

                <div style="clear: both"></div>
                <br>
                <h2 style="text-align: center;" class="bold"><span>BIÊN BẢN NGHIỆM THU</span></h2>
                <i>Hôm nay, &emsp; Ngày
                    <input type="text" id="day1" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="day1-print"></span>
                    Tháng
                    <input type="text" id="month1" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="month1-print"></span>
                    Năm
                    <input type="text" id="year1" class="date-input"
                        style="width: 50px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="year1-print"></span>
                </i>
                <br>
                <i>Tại văn phòng công ty: </i><span id="companyName"></span>
                <br>
                <i>Địa chỉ: </i><span id="companyAddress"></span>
                <br>
                <div class="bold">1. Thời gian nghiệm thu: </div>
                <i>Bắt đầu: &emsp;
                    Giờ
                    <input type="text" id="hour1" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="hour1-print"></span>
                    Phút
                    <input type="text" id="phut1" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="phut1-print"></span>
                    Ngày
                    <input type="text" id="day2" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="day2-print"></span>
                    Tháng
                    <input type="text" id="month2" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="month2-print"></span>
                    Năm
                    <input type="text" id="year2" class="date-input"
                        style="width: 50px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="year2-print"></span>
                </i> <br>
                <i>kết thúc: &emsp;
                    Giờ
                    <input type="text" id="hour2" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="hour2-print"></span>
                    Phút
                    <input type="text" id="phut2" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="phut2-print"></span>
                    Ngày
                    <input type="text" id="day3" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="day3-print"></span>
                    Tháng
                    <input type="text" id="month3" class="date-input"
                        style="width: 30px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="month3-print"></span>
                    Năm
                    <input type="text" id="year3" class="date-input"
                        style="width: 50px; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="year3-print"></span>
                </i>
                <br>
                <div class="bold">2. Hội đồng nghiệm thu bao gồm:</div>
                <div style="display: flex; justify-content: space-between;">

                    <div class="participants-container">
                        <div class="column">
                            <table class="participant-table">
                                <tr>
                                    <th colspan="6">Đại diện chủ đầu tư:</th>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">1. Ông/Bà: <input type="text" id="companyA-person1"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyA-position1"
                                            class="participant-input"></td>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">2. Ông/Bà: <input type="text" id="companyA-person2"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyA-position2"
                                            class="participant-input"></td>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">3. Ông/Bà: <input type="text" id="companyA-person3"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyA-position3"
                                            class="participant-input"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="participants-container">
                        <div class="column">
                            <table class="participant-table">
                                <tr>
                                    <th colspan="6">Đại diện đơn vị cung cấp: Công ty Cổ Phần Tập đoàn WOWS</th>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">1. Ông/Bà: <input type="text" id="companyB-person1"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyB-position1"
                                            class="participant-input"></td>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">2. Ông/Bà: <input type="text" id="companyB-person2"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyB-position2"
                                            class="participant-input"></td>
                                </tr>
                                <tr class="participant-row">
                                    <td colspan="2">3. Ông/Bà: <input type="text" id="companyB-person3"
                                            class="participant-input"></td>
                                    <td colspan="2">Chức vụ: <input type="text" id="companyB-position3"
                                            class="participant-input"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bold">3. Hội đồng nghiệm thu đã tiến hành:</div>
                <div>Xem xét hồ sơ tài liệu sau:</div>
                <div>Báo giá/hợp đồng số: <span id="id" class="bold"></span></div>
                <p class="bold">Kiểm tra thực tế thông tin tính năng của sản phẩm dịch vụ theo danh mục:</p>

                <table class="table table-bordered">
                    <thead class="center-content">
                        <tr>
                            <th class="center col-stt" rowspan="2">STT</th>
                            <th class="col-ten-sp" rowspan="2">Tên sản phẩm</th>
                            <th class="col-quy-cach" rowspan="2">Mô tả sản phẩm</th>
                            <th class="col-dvt" rowspan="2">Đơn vị tính</th>
                            <th class="col-so-luong" rowspan="2">Số lượng</th>
                            <th class="col-link" rowspan="2">Link bàn giao (Nếu có)</th>
                            <th class="col-thoi-gian" colspan="2">Thời gian thử</th>
                            <th class="col-nghiem-thu" rowspan="2">Kết quả nghiệm thu</th>
                        </tr>
                        <tr>
                            <th>Bắt đầu</th>
                            <th>Hoàn thành</th>
                        </tr>
                    </thead>
                    <tbody id="orderDetailsBody">
                        <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                    </tbody>
                </table>

                <div class="bold">4. Những sửa đổi lớn so với yêu cầu ban đầu:</div>
                <i>
                    <input type="text" id="ghichu" class="date-input"
                        style="width: 100%; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="ghichu-print"></span>
                </i>
                <br>
                <div class="bold">5. Kiến nghị:</div>
                <i>
                    <input type="text" id="kiennghi" class="date-input"
                        style="width: 100%; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="kiennghi-print"></span>
                </i>
                <br>
                <div class="bold">6. Kết luận:</div>
                <i>
                    <input type="text" id="ketluan" class="date-input"
                        style="width: 100%; border: none; border-bottom: 1px solid black;">
                    <span class="print-only" id="ketluan-print"></span>
                </i> <br>
                <i>Xác nhận của các thành phần tham gia hội đồng nghiệm thu :</i>

                <div id="footerInfo" class="mt-4">
                    <!-- Thông tin cuối sẽ được thêm vào đây -->
                </div>
            </div>
        </div>
    </page>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/printThis/1.15.0/printThis.min.js"
        integrity="sha512-d5Jr3NflEZmFDdFHZtxeJtBzk0eB+kkRXWFQqEc1EKmolXjHm2IKCA7kTvXBNjIYzjXfD5XzIjaaErpkZHCkBg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.centeronline.edu.vn/js/customer.js" type="text/javascript"></script>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzbbhvgeKfcvQpwmbZtDwW2pbBtX0uX9HJ-ALRPH9YnpacpBjIMMwE5R3NMO6I6yy_GuQ/exec';

        // Biến toàn cục để lưu trữ dữ liệu
        var BAN_GIAO = {};
        var CT_BANGIAO = [];
        var KHTN = {};
        var DKTT = [];

        function searchContract(soBG) {
            console.log('🔍 Bắt đầu tìm kiếm với SOBG:', soBG);

            if (!soBG) {
                console.error('❌ Số hợp đồng không được để trống');
                return;
            }

            console.log('📡 Đang gọi API...');

            fetch(`${API_URL}?SOBG=${encodeURIComponent(soBG)}`)
                .then(response => {
                    console.log('📥 Response nhận được:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Data nhận được:', data);

                    if (data.success) {
                        BAN_GIAO = data.ban_giao || {};
                        CT_BANGIAO = data.chitiet_bangiao || [];
                        KHTN = data.khtn || {};
                        DKTT = data.hd || []; // Sửa từ dktt thành hd

                        console.log('📊 Dữ liệu đã parse:');
                        console.log('- BAN_GIAO:', BAN_GIAO);
                        console.log('- CT_BANGIAO:', CT_BANGIAO);
                        console.log('- KHTN:', KHTN);

                        updateUI();
                    } else {
                        console.error('❌ API trả về lỗi:', data.message);
                        alert('Lỗi từ server: ' + (data.message || 'Không xác định'));
                    }
                })
                .catch(error => {
                    console.error('❌ Lỗi khi gọi API:', error);
                    alert('Đã xảy ra lỗi khi tải dữ liệu: ' + error.message);
                });
        }

        function updateUI() {
            console.log('🔄 Bắt đầu cập nhật UI...');

            try {
                // Cập nhật số hợp đồng
                const idContainer = document.getElementById('id');
                if (idContainer) {
                    const input = idContainer.querySelector('input');
                    const printSpan = idContainer.querySelector('.print-only');

                    const soHD = BAN_GIAO['Số HĐ'] || '';
                    console.log('📄 Số HĐ:', soHD);

                    if (input) input.value = soHD;
                    if (printSpan) printSpan.textContent = soHD;
                }

                // Cập nhật thông tin công ty
                const companyName = KHTN['TÊN CÔNG TY'] || '';
                const companyAddress = KHTN['ĐỊA CHỈ'] || '';
                const tenVietTat = KHTN['TÊN VIẾT TẮT'] || '';

                console.log('🏢 Thông tin công ty:', { companyName, companyAddress, tenVietTat });

                const companyNameEl = document.getElementById('companyName');
                const companyAddressEl = document.getElementById('companyAddress');
                const tvtEl = document.getElementById('Tvt');

                if (companyNameEl) companyNameEl.textContent = companyName;
                if (companyAddressEl) companyAddressEl.textContent = companyAddress;
                if (tvtEl) tvtEl.textContent = tenVietTat;

                console.log('📋 Cập nhật bảng sản phẩm...');
                updateProductTable();

                console.log('🔗 Thêm event listeners...');
                addInputListeners();

                console.log('📝 Cập nhật footer...');
                updateFooter();

                console.log('✅ Hoàn thành cập nhật UI');

            } catch (error) {
                console.error('❌ Lỗi trong updateUI:', error);
                alert('Lỗi khi cập nhật giao diện: ' + error.message);
            }
        }

        function updateProductTable() {
            console.log('📊 Cập nhật bảng với dữ liệu:', CT_BANGIAO);

            const tableBody = document.getElementById('orderDetailsBody');
            if (!tableBody) {
                console.error('❌ Không tìm thấy element orderDetailsBody');
                return;
            }

            if (!CT_BANGIAO || CT_BANGIAO.length === 0) {
                console.log('⚠️ Không có dữ liệu chi tiết bàn giao');
                tableBody.innerHTML = '<tr><td colspan="9" class="center">Không có dữ liệu sản phẩm</td></tr>';
                return;
            }

            try {
                const htmlContent = CT_BANGIAO.map((item, index) => {
                    console.log(`📦 Xử lý item ${index}:`, item);

                    return `
                    <tr>
                        <td class="center">${index + 1}</td>
                        <td>${item['Ten_hang_hoa/dich_vu'] || item['Tên sản phẩm'] || ''}</td>
                        <td class="preserve-format">${item['Chi_tiet_hang_hoa'] || item['Mô tả'] || ''}</td>
                        <td>${item['DVT'] || item['Đơn vị tính'] || ''}</td>
                        <td class="center">${item['So_luong'] || item['Số lượng'] || ''}</td>
                        <td class="preserve-format">
                            <input type="text" class="form-control link-bangiao" value="${item['Link_bangiao'] || ''}" placeholder="Link bàn giao">
                            <span class="print-only">${item['Link_bangiao'] || ''}</span>
                        </td>
                        <td>
                            <input type="text" class="form-control nguoi-tiepnhan" placeholder="Từ ngày" value="">
                            <span class="print-only"></span>
                        </td>
                        <td>
                            <input type="text" class="form-control nguoi-tiepnhan" placeholder="Đến ngày" value="">
                            <span class="print-only"></span>
                        </td>
                        <td class="center">
                            <label class="checkbox-container no-print">
                                <input type="checkbox" class="form-control ket-quanghiemthu">
                                <span class="checkmark"></span>
                            </label>
                            <span class="print-only ket-qua-text">Chưa kiểm tra</span>
                        </td>
                    </tr>
                `;
                }).join('');

                tableBody.innerHTML = htmlContent;
                console.log('✅ Đã cập nhật bảng thành công');

            } catch (error) {
                console.error('❌ Lỗi khi tạo HTML cho bảng:', error);
                tableBody.innerHTML = '<tr><td colspan="9" class="center">Lỗi khi hiển thị dữ liệu</td></tr>';
            }
        }

        // Đơn giản hóa addInputListeners để tránh vòng lặp
        function addInputListeners() {
            console.log('🔗 Đang thêm event listeners...');

            try {
                // Chỉ thêm listener cho các element mới, tránh duplicate
                const inputs = document.querySelectorAll('.link-bangiao, .nguoi-tiepnhan');
                console.log('📝 Tìm thấy', inputs.length, 'inputs');

                inputs.forEach((input, index) => {
                    // Kiểm tra xem đã có listener chưa
                    if (!input.hasAttribute('data-listener-added')) {
                        const printSpan = input.nextElementSibling;
                        if (printSpan && printSpan.classList.contains('print-only')) {
                            printSpan.textContent = input.value;

                            input.addEventListener('input', function () {
                                printSpan.textContent = this.value;
                            });

                            input.setAttribute('data-listener-added', 'true');
                        }
                    }
                });

                // Xử lý checkbox
                const checkboxes = document.querySelectorAll('.ket-quanghiemthu');
                console.log('☑️ Tìm thấy', checkboxes.length, 'checkboxes');

                checkboxes.forEach(checkbox => {
                    if (!checkbox.hasAttribute('data-listener-added')) {
                        const printSpan = checkbox.closest('td').querySelector('.ket-qua-text');
                        if (printSpan) {
                            checkbox.addEventListener('change', function () {
                                printSpan.textContent = this.checked ? 'Đạt' : 'Không đạt';
                            });

                            checkbox.setAttribute('data-listener-added', 'true');
                        }
                    }
                });

                console.log('✅ Hoàn thành thêm listeners');

            } catch (error) {
                console.error('❌ Lỗi khi thêm listeners:', error);
            }
        }

        // Các function khác giữ nguyên nhưng thêm try-catch
        function updateFooter() {
            try {
                const footerInfo = document.getElementById('footerInfo');
                if (!footerInfo) return;

                let footerHTML = `
                <table style="width: 100%; text-align: center;">
                    <tbody>
                        <tr>
                            <td style="width: 50%;"><span class="bold">Đại diện đơn vị cung cấp</span></td>
                            <td style="width: 50%;"><span class="bold">Đại diện chủ đầu tư</span></td>
                        </tr>
                        <tr>
                            <td style="width: 50%;"><span class="bold">CÔNG TY CỔ PHẦN TẬP ĐOÀN WOWS</span></td>
                            <td style="width: 50%;"><span class="bold">${KHTN['TÊN CÔNG TY'] || 'TÊN CÔNG TY'}</span></td>
                        </tr>
                        <tr>
                            <td>(Ký, đóng dấu và ghi rõ họ tên) <br><br><br><br><br><br></td>
                            <td>(Ký, đóng dấu và ghi rõ họ tên) <br><br><br><br><br><br></td>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" class="bold signature-input no-print" value="BÀ ĐỖ THỊ KIM THỦY" style="text-align: center; width: 100%; border: none; border-bottom: 1px solid #ccc;">
                                <p class="bold print-only signature-text">BÀ ĐỖ THỊ KIM THỦY</p>
                            </td>
                            <td>
                                <input type="text" class="bold signature-input no-print" value="${KHTN['NGƯỜI LIÊN HỆ'] || 'NGƯỜI LIÊN HỆ'}" style="text-align: center; width: 100%; border: none; border-bottom: 1px solid #ccc;">
                                <p class="bold print-only signature-text">${KHTN['NGƯỜI LIÊN HỆ'] || 'NGƯỜI LIÊN HỆ'}</p>
                            </td>
                        </tr>
                        <tr>
                            <td><i>Ngày ký: ..............................</i></td>
                            <td><i>Ngày ký: ..............................</i></td>
                        </tr>
                    </tbody>
                </table>
            `;

                footerInfo.innerHTML = footerHTML;

            } catch (error) {
                console.error('❌ Lỗi trong updateFooter:', error);
            }
        }

        function print() {
            $('#content').printThis({
                debug: false,
                importCSS: true,
                importStyle: true,
                printContainer: true,
                pageTitle: "",
                removeInline: false,
                removeInlineSelector: "*",
                printDelay: 333,
                header: null,
                footer: null,
                base: false,
                formValues: true,
                canvas: false,
                removeScripts: false,
                copyTagClasses: false
            });
        }

        // DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 DOM đã load, khởi tạo...');

            try {
                // Thiết lập ngày tháng
                var today = new Date();
                var day = today.getDate();
                var month = today.getMonth() + 1;
                var year = today.getFullYear();

                // Điền ngày hôm nay
                const dateFields = ['day1', 'month1', 'year1', 'day2', 'month2', 'year2', 'day3', 'month3', 'year3'];
                dateFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        if (fieldId.includes('day')) {
                            field.value = day;
                        } else if (fieldId.includes('month')) {
                            field.value = month;
                        } else if (fieldId.includes('year')) {
                            field.value = year;
                        }
                    }
                });

                // Thiết lập input cho số hợp đồng
                const idSpan = document.getElementById('id');
                if (idSpan && !idSpan.querySelector('input')) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.style.cssText = 'border: none; border-bottom: 1px solid #ccc; font-weight: bold; width: 200px; padding: 2px 5px;';
                    input.classList.add('no-print');

                    const printSpan = document.createElement('span');
                    printSpan.classList.add('print-only');
                    printSpan.style.cssText = 'display: none; font-weight: bold;';

                    input.addEventListener('input', function () {
                        printSpan.textContent = this.value;
                    });

                    idSpan.appendChild(input);
                    idSpan.appendChild(printSpan);
                }

                // Thiết lập ngày hiện tại
                var currentDateSpan = document.getElementById('currentDate');
                if (currentDateSpan) {
                    currentDateSpan.textContent = String(day).padStart(2, '0') + '.' + String(month).padStart(2, '0');
                }

                // Tìm kiếm hợp đồng từ URL
                const urlParams = new URLSearchParams(window.location.search);
                const soBG = urlParams.get('SOBG');

                console.log('🔍 SOBG từ URL:', soBG);

                if (soBG) {
                    // Delay một chút để đảm bảo trang đã render xong
                    setTimeout(() => {
                        searchContract(soBG);
                    }, 100);
                } else {
                    console.warn('⚠️ Không có SOBG trong URL');
                }

            } catch (error) {
                console.error('❌ Lỗi trong DOMContentLoaded:', error);
            }
        });
    </script>
</body>

</html>